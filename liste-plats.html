<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Liste des plats</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <h1>üçõ Tous les plats enregistr√©s</h1>

  <div class="container" style="justify-content: center;">
    <div id="resultat" style="width: 100%;">
      <div id="liste" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;"></div>
    </div>
  </div>

  <!-- Nouveau bouton pour tout supprimer -->
  <button id="btnSupprimerTous" class="btn btn-bleu">Supprimer tous les plats</button>

  <!-- Bouton existant pour revenir -->
  <button id="btnRetourGestion" class="btn btn-bleu" onclick="window.location.href='gestion.html'">‚Üê Retour √† la gestion des plats</button>
  <button id="btnDeconnexion" class="btn btn-bleu" style="display: none;">D√©connexion</button>

  <footer style="margin-top:20px; font-style: italic; color: #666;">
    Connect√© en tant que : <span id="userEmail">Chargement...</span>
  </footer>

  <script type="module">
    import {
      auth,
      onAuthStateChanged,
      signOut,
      chargerPlatsFirebase,
      sauvegarderPlatsFirebase
    } from "./firebase.js";

    const userEmailSpan = document.getElementById("userEmail");
    const btnDeconnexion = document.getElementById("btnDeconnexion");
    const btnSupprimerTous = document.getElementById("btnSupprimerTous");
    const liste = document.getElementById("liste");
    const mode = sessionStorage.getItem("mode") || "invite";

    let plats = [];
    let currentUser = null;

    function afficherListe() {
      liste.innerHTML = "";
      if (plats.length === 0) {
        liste.innerHTML = "<p>Aucun plat enregistr√©.</p>";
        return;
      }

      plats.sort((a, b) => a.nom.toLowerCase().localeCompare(b.nom.toLowerCase()));
      plats.forEach((plat, index) => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <h3>${plat.nom}</h3>
          <p><strong>Pays :</strong> ${plat.pays}</p>
          <p><strong>Continent :</strong> ${plat.continent}</p>
          <p><em>${plat.description}</em></p>
          <button class="btn-supprimer" data-index="${index}">Supprimer ce plat</button>
        `;
        div.querySelector("button").onclick = () => supprimerPlat(index);
        liste.appendChild(div);
      });
    }

    async function supprimerPlat(index) {
      if (!confirm("Voulez-vous vraiment supprimer ce plat ?")) return;

      plats.splice(index, 1);

      if (mode === "connecte" && currentUser) {
        await sauvegarderPlatsFirebase(plats, currentUser);
      } else {
        localStorage.setItem("platsPerso", JSON.stringify(plats));
      }

      afficherListe();
    }

    btnSupprimerTous.onclick = async () => {
      if (!confirm("Voulez-vous vraiment supprimer TOUS les plats ?")) return;

      plats = [];

      if (mode === "connecte" && currentUser) {
        await sauvegarderPlatsFirebase(plats, currentUser);
      } else {
        localStorage.setItem("platsPerso", JSON.stringify(plats));
      }

      afficherListe();
    };

    async function chargerPlats() {
      if (mode === "connecte" && currentUser) {
        plats = await chargerPlatsFirebase(currentUser);
      } else {
        plats = JSON.parse(localStorage.getItem("platsPerso")) || [];
      }
      afficherListe();
    }

     // Fonction notification custom
    let notificationTimeout;

    function showNotification(message, duration = 3000, type = 'info') {
  const notification = document.getElementById('notification');
  notification.textContent = message;

  // Nettoyer les classes de type avant d'ajouter la bonne
  notification.classList.remove('fade-out', 'visible', 'error', 'info');

  // Ajouter la classe correspondant au type (par d√©faut 'info')
  notification.classList.add('visible', type);

  if (notificationTimeout) clearTimeout(notificationTimeout);

  notificationTimeout = setTimeout(() => {
    notification.classList.add('fade-out');
    setTimeout(() => {
      notification.classList.remove('visible', 'fade-out', 'error', 'info');
    }, 400);
  }, duration);
}

    btnDeconnexion.onclick = async () => {
      await signOut(auth);
      sessionStorage.clear();
      window.location.href = "index.html";
    };

    onAuthStateChanged(auth, (user) => {
      currentUser = user;

      if (mode === "connecte") {
        if (!user) {
           showNotification("Veuillez vous reconnecter.",3000,'error');
          window.location.href = "index.html";
          return;
        }
        userEmailSpan.textContent = user.email || user.displayName || "Utilisateur connect√©";
        btnDeconnexion.style.display = "inline-block";
        btnDeconnexion.textContent = "D√©connexion";
      } else {
        userEmailSpan.textContent = "Mode invit√©";
        btnDeconnexion.style.display = "inline-block";
        btnDeconnexion.textContent = "Retour √† l'accueil";
      }


      chargerPlats();
    });
  </script>
</body>
</html>
