<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Liste des plats</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <h1>üçõ Tous les plats enregistr√©s</h1>

  <div class="container" style="justify-content: center;">
    <div id="resultat" style="width: 100%;">
      <div id="liste" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;"></div>
    </div>
  </div>

  <button id="btnRetourGestion" onclick="window.location.href='gestion.html'">‚Üê Retour √† la gestion des plats</button>

  <footer style="margin-top:20px; font-style: italic; color: #666;">
    Connect√© en tant que : <span id="userEmail">Non connect√©</span>
  </footer>

  <script type="module">
    import {
      onAuthStateChanged,
      chargerPlatsFirebase,
      supprimerPlatFirebase,
      sauvegarderPlatsFirebase
    } from "./firebase.js";

    const userEmailSpan = document.getElementById("userEmail");
    const liste = document.getElementById("liste");
    const mode = sessionStorage.getItem("mode") || "invite"; // "connecte" ou "invite"

    let plats = [];
    let currentUser = null;

    function afficherListe() {
      liste.innerHTML = "";
      if (plats.length === 0) {
        liste.innerHTML = "<p>Aucun plat enregistr√©.</p>";
        return;
      }
      plats.sort((a, b) => a.nom.toLowerCase().localeCompare(b.nom.toLowerCase()));
      plats.forEach((plat, index) => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <h3>${plat.nom}</h3>
          <p><strong>Pays :</strong> ${plat.pays}</p>
          <p><strong>Continent :</strong> ${plat.continent}</p>
          <p><em>${plat.description}</em></p>
          <button data-index="${index}">Supprimer ce plat</button>
        `;
        div.querySelector("button").onclick = () => supprimerPlat(index);
        liste.appendChild(div);
      });
    }

    async function supprimerPlat(index) {
      if (!confirm("Voulez-vous vraiment supprimer ce plat ?")) return;

      plats.splice(index, 1);

      if (mode === "connecte" && currentUser) {
        await sauvegarderPlatsFirebase(plats, currentUser);
      } else {
        localStorage.setItem("platsPerso", JSON.stringify(plats));
      }
      afficherListe();
    }

    async function chargerPlats() {
      if (mode === "connecte" && currentUser) {
        plats = await chargerPlatsFirebase(currentUser);
      } else {
        plats = JSON.parse(localStorage.getItem("platsPerso")) || [];
      }
      afficherListe();
    }

    onAuthStateChanged((user) => {
      currentUser = user;
      if (mode === "connecte") {
        if (!user) {
          alert("Veuillez vous connecter.");
          window.location.href = "index.html";
          return;
        }
        userEmailSpan.textContent = user.email || user.displayName || "Utilisateur connect√©";
      } else {
        userEmailSpan.textContent = "Mode invit√©";
      }
      chargerPlats();
    });

  </script>
</body>
</html>
