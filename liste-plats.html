<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Liste des plats</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <h1>üçõ Tous les plats enregistr√©s</h1>
  <div id="auth">
  <button id="btnAuth">Se connecter avec Google</button>
  <span id="userInfo" style="margin-left: 10px;"></span>
</div>

  <div class="container" style="justify-content: center;">
    <div id="resultat" style="width: 100%;">
      <div id="liste" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;"></div>
    </div>
  </div>

  <button id="btnRetourGestion" onclick="window.location.href='gestion.html'">‚Üê Retour √† la gestion des plats</button>
  <button onclick="sauvegarderSurFirebase()">üíæ Sauvegarder sur le cloud</button>
  <button onclick="chargerDepuisFirebase()">‚òÅÔ∏è Charger depuis le cloud</button>

 <script type="module">
  import {
    auth,
    provider,
    signInWithPopup,
    signOut,
    onAuthStateChanged,
    sauvegarderPlatsFirebase,
    chargerPlatsFirebase,
  } from "./firebase.js";

  const btnAuth = document.getElementById("btnAuth");
  const infoUser = document.getElementById("infoUser");
  const liste = document.getElementById("liste");

  let currentUser = null;
  let plats = JSON.parse(localStorage.getItem("platsPerso")) || [];

  function afficherListe() {
    liste.innerHTML = "";
    plats.sort((a, b) => a.nom.toLowerCase().localeCompare(b.nom.toLowerCase()));

    if (plats.length === 0) {
      liste.innerHTML = "<p>Aucun plat enregistr√©.</p>";
    } else {
      plats.forEach((plat, index) => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <h3>${plat.nom}</h3>
          <p><strong>Pays :</strong> ${plat.pays}</p>
          <p><strong>Continent :</strong> ${plat.continent}</p>
          <p><em>${plat.description}</em></p>
          <button onclick="supprimerPlat(${index})">Supprimer ce plat</button>
        `;
        liste.appendChild(div);
      });
    }
  }

  window.supprimerPlat = function(index) {
    if (confirm("Voulez-vous vraiment supprimer ce plat ?")) {
      plats.splice(index, 1);
      localStorage.setItem("platsPerso", JSON.stringify(plats));
      afficherListe();
    }
  };

  window.sauvegarderSurFirebase = function () {
    if (!currentUser) {
      alert("Veuillez vous connecter pour sauvegarder.");
      return;
    }
    if (plats.length === 0) {
      alert("Aucun plat √† sauvegarder.");
      return;
    }

    sauvegarderPlatsFirebase(plats, currentUser)
      .then(() => alert("‚úÖ Liste sauvegard√©e sur le cloud !"))
      .catch((err) => {
        console.error(err);
        alert("‚ùå Erreur de sauvegarde.");
      });
  };

  window.chargerDepuisFirebase = function () {
    if (!currentUser) {
      alert("Veuillez vous connecter.");
      return;
    }

    chargerPlatsFirebase(currentUser)
      .then((platsCloud) => {
        const platsLocal = JSON.parse(localStorage.getItem("platsPerso")) || [];
        const nomsLocal = platsLocal.map((p) => p.nom.toLowerCase());

        const platsFusionnes = [
          ...platsLocal,
          ...platsCloud.filter((p) => !nomsLocal.includes(p.nom.toLowerCase())),
        ];

        localStorage.setItem("platsPerso", JSON.stringify(platsFusionnes));
        alert("‚úÖ Liste fusionn√©e avec le cloud !");
        location.reload();
      })
      .catch((err) => {
        console.error("Erreur lors du chargement :", err);
        alert("Erreur lors du chargement depuis le cloud.");
      });
  };

  btnAuth.onclick = () => {
    if (currentUser) {
      signOut(auth);
    } else {
      signInWithPopup(auth, provider).catch((err) => {
        console.error("Erreur connexion :", err);
        alert("Erreur lors de la connexion.");
      });
    }
  };

  onAuthStateChanged(auth, (user) => {
    currentUser = user;
    if (user) {
      infoUser.textContent = `Connect√© : ${user.displayName}`;
      btnAuth.textContent = "D√©connexion";
    } else {
      infoUser.textContent = "Non connect√©";
      btnAuth.textContent = "Connexion";
    }
  });

  afficherListe();
</script>
</body>
</html>
