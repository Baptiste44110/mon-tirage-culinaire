<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Liste des plats</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <h1>üçõ Tous les plats enregistr√©s</h1>

  <div class="container" style="justify-content: center;">
    <div id="resultat" style="width: 100%;">
      <div id="liste" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;"></div>
    </div>
  </div>

  <button id="btnRetourGestion" onclick="window.location.href='gestion.html'">‚Üê Retour √† la gestion des plats</button>
  <button onclick="sauvegarderSurFirebase()">üíæ Sauvegarder sur le cloud</button>
  <button onclick="chargerDepuisFirebase()">‚òÅÔ∏è Charger depuis le cloud</button>
  <button id="btnAuth">Connexion</button>
  <p id="infoUser">Non connect√©</p>

  <script type="module">
    import {
      sauvegarderPlatsFirebase,
      chargerPlatsFirebase,
      signInWithGoogle,
      signOutUser,
      onAuthStateChangedListener
    } from "./firebase.js";

    let plats = JSON.parse(localStorage.getItem("platsPerso")) || [];
    const liste = document.getElementById("liste");
    const btnAuth = document.getElementById("btnAuth");
    const infoUser = document.getElementById("infoUser");

    let currentUserId = null;

    function afficherListe() {
      liste.innerHTML = "";

      plats.sort((a, b) => a.nom.toLowerCase().localeCompare(b.nom.toLowerCase()));

      if (plats.length === 0) {
        liste.innerHTML = "<p>Aucun plat enregistr√©.</p>";
      } else {
        plats.forEach((plat, index) => {
          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `
            <h3>${plat.nom}</h3>
            <p><strong>Pays :</strong> ${plat.pays}</p>
            <p><strong>Continent :</strong> ${plat.continent}</p>
            <p><em>${plat.description}</em></p>
            <button onclick="supprimerPlat(${index})">Supprimer ce plat</button>
          `;
          liste.appendChild(div);
        });
      }
    }

    window.supprimerPlat = function(index) {
      if (confirm("Voulez-vous vraiment supprimer ce plat ?")) {
        plats.splice(index, 1);
        localStorage.setItem("platsPerso", JSON.stringify(plats));
        afficherListe();
      }
    };

    window.sauvegarderSurFirebase = function () {
      if (!currentUserId) {
        alert("‚ö†Ô∏è Veuillez vous connecter.");
        return;
      }

      if (plats.length === 0) {
        alert("Aucun plat √† sauvegarder.");
        return;
      }

      sauvegarderPlatsFirebase(plats, currentUserId)
        .then(() => alert("‚úÖ Liste sauvegard√©e sur le cloud !"))
        .catch((err) => {
          console.error(err);
          alert("‚ùå √âchec de la sauvegarde.");
        });
    };

    window.chargerDepuisFirebase = function () {
      if (!currentUserId) {
        alert("‚ö†Ô∏è Veuillez vous connecter.");
        return;
      }

      chargerPlatsFirebase(currentUserId)
        .then((data) => {
          if (data && Array.isArray(data)) {
            plats = data;
            localStorage.setItem("platsPerso", JSON.stringify(plats));
            alert("‚úÖ Liste charg√©e !");
            afficherListe();
          } else {
            alert("Aucune liste trouv√©e sur le cloud.");
          }
        })
        .catch((err) => {
          console.error(err);
          alert("Erreur lors du chargement.");
        });
    };

    // Auth
    btnAuth.onclick = () => {
      if (currentUserId) {
        signOutUser();
      } else {
        signInWithGoogle();
      }
    };

    onAuthStateChangedListener((user) => {
      if (user) {
        currentUserId = user.uid;
        infoUser.textContent = `Connect√© : ${user.displayName}`;
        btnAuth.textContent = "D√©connexion";
      } else {
        currentUserId = null;
        infoUser.textContent = "Non connect√©";
        btnAuth.textContent = "Connexion";
      }
    });

    // Affichage initial
    afficherListe();
  </script>
</body>
</html>
