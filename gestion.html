<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gestion des Plats</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <h1>ðŸŽ‰ GÃ©rer mes plats</h1>

  <!-- Formulaire pour ajouter un plat -->
  <div class="form-container">
    <h3>Ajouter un plat</h3>
    <form id="formAjout" onsubmit="ajouterSpecialite(event)">
      <input type="text" id="nom" placeholder="Nom du plat" required><br>
      <input type="text" id="pays" placeholder="Pays d'origine" required><br>
      <select id="continentForm">
        <option value="Afrique">Afrique</option>
        <option value="Asie">Asie</option>
        <option value="Europe">Europe</option>
        <option value="AmÃ©rique">AmÃ©rique</option>
        <option value="OcÃ©anie">OcÃ©anie</option>
      </select><br>
      <textarea id="description" placeholder="Description du plat" required></textarea><br>
      <button type="submit">Ajouter un plat</button>
    </form>
  </div>

  <!-- Bouton pour voir la liste complÃ¨te des plats -->
  <br>
  <button onclick="window.location.href='liste-plats.html'">Voir la liste complÃ¨te des plats</button>

  <!-- Export -->
  <div class="export-container">
    <h3>ðŸ“¤ Exporter vos plats personnalisÃ©s</h3>
    <button onclick="exporterPlats()">ðŸ“¥ Exporter en JSON</button>
  </div>

  <!-- Import -->
  <div class="import-container">
    <h3>ðŸ“¥ Importer des plats personnalisÃ©s</h3>
    <input type="file" accept=".json" onchange="importerPlats(event)">
    <p id="messageImport" style="color: green;"></p>
    <div id="previewImport"></div>
    <button onclick="confirmerImport()">âœ… Confirmer l'import</button>
  </div>

  <!-- Retour Ã  la roue -->
  <br>
  <button onclick="window.location.href='index.html'">Retour Ã  la roue</button>

  <script>
    let platsPerso = JSON.parse(localStorage.getItem("platsPerso")) || [];

    function ajouterSpecialite(event) {
      event.preventDefault();
      const nom = document.getElementById("nom").value.trim();
      const pays = document.getElementById("pays").value.trim();
      const continent = document.getElementById("continentForm").value;
      const description = document.getElementById("description").value.trim();

      if (!nom || !pays || !continent || !description) {
        alert("Merci de remplir tous les champs.");
        return;
      }

      const existe = platsPerso.some(p => 
        p.nom.toLowerCase() === nom.toLowerCase() &&
        p.pays.toLowerCase() === pays.toLowerCase()
      );

      if (existe) {
        alert("Ce plat existe dÃ©jÃ  dans la liste !");
        return;
      }

      const nouvelleSpecialite = { nom, pays, continent, description };
      platsPerso.push(nouvelleSpecialite);
      localStorage.setItem("platsPerso", JSON.stringify(platsPerso));
      alert("Plat ajoutÃ© avec succÃ¨s !");
      document.getElementById("formAjout").reset();
    }

    function exporterPlats() {
      if (platsPerso.length === 0) {
        alert("Aucun plat Ã  exporter !");
        return;
      }
      const dataStr = JSON.stringify(platsPerso, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const lien = document.createElement("a");
      lien.href = url;
      lien.download = "mes-plats.json";
      lien.click();
      URL.revokeObjectURL(url);
    }

    let platsImportTemporaire = [];

    function importerPlats(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const data = JSON.parse(e.target.result);
          const estValide = Array.isArray(data) && data.every(p =>
            p.nom && p.pays && p.continent && p.description
          );

          if (!estValide) {
            alert("Fichier JSON invalide ou incomplet.");
            return;
          }

          platsImportTemporaire = data;
          afficherPreviewImport(data);
        } catch (err) {
          alert("Erreur lors de la lecture du fichier JSON.");
        }
      };
      reader.readAsText(file);
    }

    function afficherPreviewImport(data) {
      const container = document.getElementById("previewImport");
      container.innerHTML = "<h4>ðŸ“¦ Plats Ã  importer :</h4>";
      data.forEach(p => {
        const div = document.createElement("div");
        div.innerHTML = `<strong>${p.nom}</strong> (${p.pays}) - ${p.continent}<br><em>${p.description}</em><hr>`;
        container.appendChild(div);
      });
    }

    function confirmerImport() {
      let platsAjoutes = 0;

      platsImportTemporaire.forEach(p => {
        const existe = platsPerso.some(e =>
          e.nom.toLowerCase() === p.nom.toLowerCase() &&
          e.pays.toLowerCase() === p.pays.toLowerCase()
        );

        if (!existe) {
          platsPerso.push(p);
          platsAjoutes++;
        }
      });

      localStorage.setItem("platsPerso", JSON.stringify(platsPerso));
      platsImportTemporaire = [];
      document.getElementById("previewImport").innerHTML = "";
      document.getElementById("messageImport").textContent =
        platsAjoutes > 0
          ? `âœ… ${platsAjoutes} plats importÃ©s avec succÃ¨s !`
          : "âš ï¸ Tous les plats Ã©taient dÃ©jÃ  prÃ©sents.";

      setTimeout(() => {
        document.getElementById("messageImport").textContent = "";
      }, 3000);
    }
  </script>
</body>
</html>
